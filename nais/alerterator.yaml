apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: tiltak-tilsagnsbrev
  namespace: arbeidsgiver
  labels:
    team: arbeidsgiver
spec:
  groups:
    - name: tiltak-tilsagnsbrev-alert
      rules:
        - alert: applikasjon nede
          expr: sum(up{app="tiltak-tilsagnsbrev", job="nais-system/monitoring-apps-tenant"}) == 0
          for: 1s
          annotations:
            summary: tiltak-tilsagnsbrev er nede
            action: "`kubectl describe pod {{ $labels.kubernetes_pod_name }} -n {{ $labels.kubernetes_namespace }}` for events, og `kubectl logs {{ $labels.kubernetes_pod_name }} -n {{ $labels.kubernetes_namespace }}` for logger"
          labels:
            namespace: arbeidsgiver
            severity: critical

        - alert: høy feilrate i logger
          expr: (sum by (log_app, log_namespace) (rate(logd_messages_total{log_app="tiltak-tilsagnsbrev",log_level=~"Error"}[3m]))) > 3
          for: 1s
          annotations:
            summary: tiltak-tilsagnsbrev feiler mye
            action: "`kubectl describe pod {{ $labels.kubernetes_pod_name }} -n {{ $labels.kubernetes_namespace }}` for events, og `kubectl logs {{ $labels.kubernetes_pod_name }} -n {{ $labels.kubernetes_namespace }}` for logger"
          labels:
            namespace: arbeidsgiver
            severity: critical

        - alert: tilsagnsbrev feilet!
          expr: sum(increase(retry_fail_total{app="tiltak-tilsagnsbrev"} [5m])) > 0
          for: 1m
          annotations:
            summary: |-
              Tilsagnsbrev feilet v/behandling :this-is-fine-fire: Sjekk loggene om noe bør gjøres!
            action: "Sjekk logs.az.nav.no for logger. Snarvei for alle feil i våre namespace: https://logs.az.nav.no/app/data-explorer/discover/#/view/f21a8b00-0cd1-11f1-b30c-21dfcb1fad46"
          labels:
            namespace: arbeidsgiver
            severity: critical
